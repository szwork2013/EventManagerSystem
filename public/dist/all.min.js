angular.module("EventApp",["ngRoute","ngResource"]).config(["$routeProvider","$httpProvider",function(e,o){e.when("/",{templateUrl:"view/index.html"}).when("/base",{templateUrl:"view/base.html",controller:"AccountCtrl"}).when("/manager",{templateUrl:"view/user/manager.html",controller:"UserManagerCtrl"}).when("/role",{templateUrl:"view/user/role.html",controller:"UserRoleCtrl"}).when("/menu",{templateUrl:"view/user/menu.html",controller:"UserMenuCtrl"}).when("/event",{templateUrl:"view/event/list.html",controller:"EventListCtrl"}).otherwise("/"),o.interceptors.push("authInterceptor")}]),angular.module("EventApp").factory("authInterceptor",["$window",function(e,o){return{request:function(e){return e.headers=e.headers||{},localStorage.jwt&&(e.headers.Authorization="Bearer "+localStorage.jwt),e},responseError:function(o){return console.log("responseError rejection:",o),401===o.status?(e.alert("登陆超时,请重新登陆"),delete e.localStorage.jwt,void(e.location.href="/")):$q.reject(o)}}}]).factory("User",["$http","$q","$resource",function(e,o,r){return{isLoggedIn:function(){return localStorage.jwt?!0:!1},isAdmin:function(){return"管理员"===localStorage.user_role_name?!0:!1},login:function(r,t){return o(function(o,n){e.post("/api/user/login",{accounts:r,password:t}).success(function(e){if(e.error)switch(e.error){case 400:n("用户名和密码不能未空.");break;case 401:n("用户名或密码错误.");break;case 500:n("Http错误. 请稍后重试.");break;default:n(e.msg)}else console.log(e),localStorage.jwt=e.jwt,localStorage.accounts=e.user.accounts,localStorage.user_role_name=e.user.role.name,localStorage.user_role_permission=e.user.role.permission,o()}).error(function(){n("服务器连接失败. 请稍后重试.")})})},logout:function(){localStorage.removeItem("jwt"),localStorage.removeItem("accounts"),localStorage.removeItem("user_role_name"),localStorage.removeItem("user_role_permission")},Rest:r("/api/user/manager/:id",{id:"@_id"})}}]).factory("Role",["$resource",function(e){return e("/api/user/role/:id",{id:"@_id"})}]).factory("Menu",["$resource",function(e){return{Rest:e("/api/user/menu/:id",{id:"@_id"})}}]).service("fileUpload",["$http",function(e){this.uploadFileToUrl=function(o,r,t){e.post(r,o,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(e){t(null,e)}).error(function(e){t(e)})}}]),angular.module("EventApp").controller("IndexCtrl",["$scope","$location","$window","User","Menu",function(e,o,r,t,n){e.isLoggedIn=t.isLoggedIn,e.isAdmin=t.isAdmin,e.user_accounts=localStorage.accounts,e.user_role_name=localStorage.user_role_name,e.user_role_permission=localStorage.user_role_permission,e.submit=function(){return t.isLoggedIn()?(t.logout(),void o.path("/")):void BootstrapDialog.show({title:"登陆",message:$('<form class="navbar-form"><div class="form-group"><input id="accounts" type="text" placeholder="账户" class="form-control"></div><br /><br /><div class="form-group"><input id="password" type="password" placeholder="密码" class="form-control"></div></form>'),cssClass:"login-dialog",type:BootstrapDialog.TYPE_SUCCESS,size:BootstrapDialog.SIZE_SMALL,buttons:[{label:"登陆",cssClass:"btn-success",action:function(n){var s=n.getModalBody().find("#accounts").val(),l=n.getModalBody().find("#password").val();return s&&l?void t.login(s,l).then(function(){n.close(),e.user_accounts=localStorage.accounts,e.user_role_name=localStorage.user_role_name,e.user_role_permission=localStorage.user_role_permission,o.path("/base")})["catch"](function(e){r.alert("错误! "+e)}):void r.alert("错误! 用户名和密码不能为空!")}}]})},e.parentList=[],n.Rest.query(function(o){o[0].message||o.forEach(function(r){r.menuList=[],o.forEach(function(e){e.parent===r.name&&r.menuList.push(e)}),""===r.parent&&e.parentList.push(r)})})}]).controller("UserManagerCtrl",["$scope","$location","$window","User",function(e,o,r,t){return t.isLoggedIn()?void t.Rest.query(function(o){o.length>0&&(e.docs=o,console.log(e.docs))}):void o.path("/")}]).controller("UserRoleCtrl",["$scope","$location","$window","User","Role",function(e,o,r,t,n){return t.isLoggedIn()?void n.query(function(o){o.length>0&&(e.docs=o,console.log(e.docs))}):void o.path("/")}]).controller("UserMenuCtrl",["$scope","$location","$window","User","Menu",function(e,o,r,t,n){if(!t.isLoggedIn())return void o.path("/");e.addMenu=function(){e.menu={name:"",parent:"",url:""}},e.deleteMenu=function(e){n.Rest.remove({id:e._id},function(e){e&&s()})},e.updateMenu=function(o){e.menu=o},e.saveMenu=function(){console.log(e.menu);var o={};e.menu._id&&(o={id:e.menu._id}),n.Rest.save(o,{menu:e.menu},function(e){0!==e.error?r.alert(e.reason):(r.alert("保存成功"),$("#modal_menu").modal("toggle"),s())})},n.Rest.query({parent:""},function(o){if(o.length>0){if(o.message)return void console.log(o.message);e.menulist=o,console.log(e.menulist)}});var s=function(){n.Rest.query(function(o){o.length>0&&(e.docs=o,console.log(e.docs))})};s()}]).controller("AccountCtrl",["$scope","$location","$window","User",function(e,o,r,t){return t.isLoggedIn()?void 0:void o.path("/")}]);